# 批量测试功能使用指南

## 功能概述

批量测试功能允许您上传包含多个测试用例的JSON文件，系统会自动执行所有测试并生成详细的测试结果报告。

## 测试文件格式

测试文件应为JSON格式，包含一个测试用例数组。每个测试用例应包含以下字段：

```json
{
  "id": "唯一标识符",
  "category": "测试类别",
  "difficulty": 难度等级（1-5）,
  "query": "测试查询",
  "expected_answer_keywords": ["期望答案关键词1", "期望答案关键词2"]
}
```

### 示例测试文件

参考 `test_queries.json` 文件，其中包含了8个测试用例的示例。

## 使用步骤

### 1. 准备测试文件

- 创建符合格式要求的JSON测试文件
- 确保文件编码为UTF-8
- 建议测试用例数量在10-100个之间

### 2. 上传文档并构建索引

在使用批量测试之前，必须先：
- 上传文本文档
- 配置V3引擎参数
- 构建文档索引

### 3. 配置LLM（可选）

如果需要AI生成答案，请配置：
- LLM服务地址
- API密钥
- 模型名称
- 自定义提示词

### 4. 执行批量测试

1. 在"批量测试"区域选择测试文件
2. 点击"开始批量测试"按钮
3. 等待测试完成（会显示进度条）
4. 查看测试摘要和结果

### 5. 下载测试结果

测试完成后，系统会生成两个文件：
- `{原文件名}_jg.json` - 详细测试结果
- `{原文件名}_jg_summary.json` - 测试摘要

## 测试结果格式

### 详细结果文件

每个测试用例的结果包含：

```json
{
  "id": "测试用例ID",
  "category": "测试类别",
  "difficulty": "难度等级",
  "query": "原始查询",
  "expected_answer_keywords": ["期望关键词"],
  "ai_answer": "AI生成的答案",
  "retrieval_results": [
    {
      "doc_id": "文档ID",
      "score": "检索分数",
      "content": "检索到的内容片段"
    }
  ],
  "metrics": {
    "retrieval_time": "检索耗时",
    "llm_latency": "LLM响应延迟",
    "total_latency": "总耗时"
  },
  "session_id": "会话ID",
  "timestamp": "测试时间戳"
}
```

### 摘要文件

包含测试统计信息：

```json
{
  "total_tests": "总测试数",
  "successful_tests": "成功测试数",
  "failed_tests": "失败测试数",
  "average_retrieval_time": "平均检索时间",
  "average_llm_latency": "平均LLM延迟",
  "test_timestamp": "测试时间戳",
  "result_file": "结果文件名",
  "recall_success_count": "召回成功数",
  "recall_failure_count": "召回失败数",
  "recall_success_rate": "召回成功率（百分比）",
  "total_successful_tests": "总成功测试数"
}
```

## 召回成功率计算

系统会自动计算召回成功率，判断标准如下：

### 召回失败判定
如果AI回复中包含以下关键字之一，则视为召回失败：
- "无法根据参考上下文回答"
- "无法"

### 召回成功率公式
```
召回成功率 = (召回成功数 / 总成功测试数) × 100%
```

### 成功率等级
- 🟢 **优秀**: ≥80% (绿色显示)
- 🟡 **良好**: 60-79% (黄色显示)  
- 🔴 **需改进**: <60% (红色显示)

## 性能优化建议

### 1. 测试用例数量

- 建议单次测试不超过100个用例
- 大量测试建议分批进行

### 2. 系统配置

- 确保有足够的内存和计算资源
- 配置合适的V3引擎参数
- 使用高效的LLM服务

### 3. 网络优化

- 如果使用外部LLM服务，确保网络稳定
- 考虑使用本地LLM模型

## 错误处理

### 常见错误

1. **索引未构建**
   - 错误：尚未上传并构建V3索引
   - 解决：先上传文档并构建索引

2. **文件格式错误**
   - 错误：JSON解析失败
   - 解决：检查JSON文件格式是否正确

3. **LLM服务错误**
   - 错误：LLM调用失败
   - 解决：检查LLM配置和网络连接

### 错误恢复

- 失败的测试用例会在结果中标记
- 可以重新运行失败的测试
- 系统会记录详细的错误信息

## 最佳实践

### 1. 测试用例设计

- 覆盖不同类型的查询
- 包含不同难度级别
- 使用清晰的期望答案关键词

### 2. 结果分析

- 关注检索时间和准确性
- 分析失败案例的原因
- 根据结果调整系统参数

### 3. 持续改进

- 定期运行测试套件
- 跟踪性能指标变化
- 优化系统配置参数

## 技术支持

如果遇到问题，请检查：
1. 系统日志输出
2. 网络连接状态
3. 文件格式和编码
4. 系统资源使用情况

---

*本指南基于V3 RAG引擎的批量测试功能编写，如有疑问请参考项目文档或联系技术支持。* 