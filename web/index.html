<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>V3 RAG 引擎测试界面</title>
    <link rel="stylesheet" href="/web/styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>V3 RAG 引擎测试界面</h1>

      <!-- 配置区域 -->
      <section class="config-section">
        <div class="config-header">
          <h2>⚙️ V3引擎配置</h2>
          <button id="clearConfigBtn" class="btn-secondary">清除配置</button>
        </div>
        <div class="config-grid">
          <!-- 文档上传 -->
          <div class="config-card">
            <h3>📄 文档上传</h3>
            <form id="uploadForm">
              <div class="form-group">
                <label>选择文本文件（.txt）：</label>
                <input type="file" id="fileInput" accept=".txt" required />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>父块大小：</label>
                  <input type="number" id="parent_chunk_size" value="1000" />
                </div>
                <div class="form-group">
                  <label>父块重叠：</label>
                  <input type="number" id="parent_overlap" value="200" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>子块大小：</label>
                  <input type="number" id="sub_chunk_size" value="200" />
                </div>
                <div class="form-group">
                  <label>子块重叠：</label>
                  <input type="number" id="sub_overlap" value="50" />
                </div>
              </div>
              <button type="submit" class="btn-primary">上传并构建索引</button>
              <div id="uploadStatus" class="status"></div>
            </form>
          </div>

          <!-- V3引擎配置 -->
          <div class="config-card">
            <h3>🚀 V3引擎配置</h3>
            
            <!-- 预设配置选择器 -->
            <div class="form-group">
              <label>预设配置：</label>
              <select id="preset_config" onchange="applyPreset()">
                <option value="">自定义配置</option>
                <option value="balanced">平衡模式</option>
                <option value="precision">精确模式</option>
                <option value="speed">快速模式</option>
                <option value="conversational">对话模式</option>
                <option value="hf_optimized">HF优化模式</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>编码后端：</label>
              <select id="encoder_backend" onchange="toggleModelInputs()">
                <option value="bge">BGE (本地模型)</option>
                <option value="hf">HuggingFace (在线模型)</option>
              </select>
            </div>
            <div class="form-group" id="bge_model_group">
              <label>BGE模型路径：</label>
              <input type="text" id="bge_model_path" placeholder="请输入本地模型路径，例如：models--BAAI--bge-small-zh-v1.5/snapshots/xxx" />
              <small class="form-hint">本地模型路径，需要先下载到本地</small>
            </div>
            <div class="form-group" id="hf_model_group" style="display: none;">
              <label>HF模型名：</label>
              <input type="text" id="hf_model_name" placeholder="例如：BAAI/bge-small-zh-v1.5" />
              <small class="form-hint">HuggingFace模型名称，将自动下载</small>
            </div>
            <div class="form-group">
              <label>嵌入维度：</label>
              <input type="number" id="embedding_dim" value="512" min="128" max="1024" step="128" />
            </div>
            
            <!-- 混合搜索配置 -->
            <div class="form-row">
              <div class="form-group">
                <label>BM25权重：</label>
                <input type="number" id="bm25_weight" value="1.0" step="0.1" min="0" max="5" />
              </div>
              <div class="form-group">
                <label>ColBERT权重：</label>
                <input type="number" id="colbert_weight" value="1.5" step="0.1" min="0" max="5" />
              </div>
            </div>
            
            <!-- 高级优化配置 -->
            <div class="form-row">
              <div class="form-group">
                <label>多头数量：</label>
                <input type="number" id="num_heads" value="8" min="1" max="16" />
              </div>
              <div class="form-group">
                <label>上下文影响：</label>
                <input type="number" id="context_influence" value="0.3" step="0.1" min="0" max="1" />
              </div>
            </div>
            
            <!-- 新增的高级配置 -->
            <div class="form-row">
              <div class="form-group">
                <label>长度惩罚系数：</label>
                <input type="number" id="length_penalty_alpha" value="0.05" step="0.01" min="0" max="0.5" />
              </div>
              <div class="form-group">
                <label>上下文记忆衰减：</label>
                <input type="number" id="context_memory_decay" value="0.8" step="0.1" min="0" max="1" />
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>BM25候选数量：</label>
                <input type="number" id="bm25_top_n" value="100" min="10" max="500" />
              </div>
              <div class="form-group">
                <label>Top-K 结果：</label>
                <input type="number" id="final_top_k" value="10" min="1" max="50" />
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>编码批次大小：</label>
                <input type="number" id="encode_batch_size" value="64" min="1" max="256" />
              </div>
              <div class="form-group">
                <label>最大序列长度：</label>
                <input type="number" id="max_length" value="256" min="128" max="512" />
              </div>
            </div>
            
            <!-- 功能开关 -->
            <div class="form-row">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="use_hybrid_search" checked />
                  启用混合搜索
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="use_multi_head" checked />
                  启用多头注意力
                </label>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="use_length_penalty" checked />
                  启用长度惩罚
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="use_stateful_reranking" checked />
                  启用状态化重排序
                </label>
              </div>
            </div>
            
            <!-- 新增: 重排序配置 -->
            <div class="reranker-config">
              <h4>🚀 交叉编码器重排序</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="use_reranker" checked />
                    启用交叉编码器重排序
                  </label>
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="enable_amp_if_beneficial" checked />
                    启用AMP优化
                  </label>
                </div>
              </div>
              
              <!-- 重排序详细配置 -->
              <div class="form-row">
                <div class="form-group">
                  <label>重排序模型：</label>
                  <input type="text" id="reranker_model_name" value="BAAI/bge-reranker-large" placeholder="重排序模型名称，例如：BAAI/bge-reranker-large" />
                  <small class="form-hint">默认使用在线模型 BAAI/bge-reranker-large</small>
                </div>
                <div class="form-group">
                  <label>重排序候选数量：</label>
                  <input type="number" id="reranker_top_n" value="50" min="10" max="200" />
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>重排序权重：</label>
                  <input type="number" id="reranker_weight" value="1.5" step="0.1" min="0" max="5" />
                </div>
                <div class="form-group">
                  <label>重排序后端：</label>
                  <select id="reranker_backend">
                    <option value="auto">自动选择 (推荐)</option>
                    <option value="flagembedding">FlagEmbedding</option>
                    <option value="transformers">HuggingFace Transformers</option>
                    <option value="onnx">ONNX Runtime</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="precompute_doc_tokens" />
                  预计算文档Token向量
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="enable_amp_if_beneficial" checked />
                  启用AMP优化
                </label>
              </div>
            </div>
            
            <!-- 配置管理按钮 -->
            <div class="config-actions">
              <button type="button" onclick="saveConfig()" class="btn btn-primary">
                💾 保存配置
              </button>
              <button type="button" onclick="loadConfig()" class="btn btn-secondary">
                📂 加载配置
              </button>
              <button type="button" onclick="clearConfig()" class="btn btn-warning">
                🗑️ 清除配置
              </button>
              <button type="button" onclick="validateAndShowConfig()" class="btn btn-info">
                ✅ 验证配置
              </button>
            </div>
          </div>

          <!-- LLM配置 -->
          <div class="config-card">
            <h3>🤖 LLM配置</h3>
            <div class="form-group">
              <label>Base URL：</label>
              <input type="text" id="base_url" placeholder="例如：https://api.openai.com" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>模型名：</label>
                <input type="text" id="model" placeholder="例如：gpt-4o-mini" />
              </div>
              <div class="form-group">
                <label>API Key：</label>
                <input type="password" id="api_key" placeholder="sk-..." />
              </div>
            </div>
            <div class="form-group">
              <label>RAG 提示词：</label>
              <textarea id="prompt" rows="3" placeholder="自定义系统提示词，强调必须严格依据上下文回答"></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- 问答区域 -->
      <section class="qa-section">
        <div class="qa-header">
          <h2>💬 V3引擎问答测试</h2>
          <div class="qa-input-group">
            <input type="text" id="question" placeholder="请输入你的问题..." />
            <button id="askBtn" class="btn-primary">开始检索</button>
          </div>
        </div>

        <!-- V3引擎结果 -->
        <div class="v3-result-container">
          <div class="v3-panel">
            <div class="panel-header">
              <h3>🚀 V3引擎结果</h3>
              <div class="status-indicator" id="v3Status">等待提问</div>
            </div>
            <div class="answer-area">
              <div class="answer-content" id="v3Answer">请输入问题开始测试...</div>
            </div>
            <div class="context-area">
              <h4>📚 检索结果</h4>
              <div class="context-list" id="v3Ctx"></div>
            </div>
            <div class="metrics-area">
              <h4>📊 检索指标</h4>
              <div class="metrics-grid" id="v3Metrics"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 批量测试区域 -->
      <section class="batch-test-section">
        <div class="batch-test-header">
          <h2>🧪 批量测试</h2>
          <button id="refreshResultsBtn" class="btn-secondary">刷新结果列表</button>
        </div>
        
        <div class="batch-test-container">
          <!-- 测试文件上传 -->
          <div class="test-upload-card">
            <h3>📋 测试文件上传</h3>
            <form id="batchTestForm">
              <div class="form-group">
                <label>选择测试文件（JSON格式）：</label>
                <input type="file" id="testFileInput" accept=".json" required />
                <small>支持您提供的测试数据结构格式</small>
              </div>
              
              <!-- 结果选项 -->
              <div class="result-option">
                <label>
                  <input type="checkbox" id="include_contexts" />
                  在测试结果中包含召回的选段
                </label>
                <small>勾选将包含检索到的文档片段，取消勾选将只保存AI回答</small>
              </div>
              
              <button type="submit" class="btn-primary">开始批量测试</button>
              <div id="batchTestStatus" class="status"></div>
            </form>
          </div>

          <!-- 测试进度 -->
          <div class="test-progress-card" id="testProgressCard" style="display: none;">
            <h3>📊 测试进度</h3>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">准备中...</div>
            <div class="test-summary" id="testSummary"></div>
          </div>

          <!-- 测试结果列表 -->
          <div class="test-results-card">
            <h3>📁 测试结果文件</h3>
            <div class="results-list" id="resultsList">
              <div class="loading">加载中...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 历史记录 -->
      <section class="history-section">
        <div class="history-header">
          <h3>📝 问答历史</h3>
          <button id="clearHistoryBtn" class="btn-secondary">清除历史</button>
        </div>
        <div class="history-list" id="historyList"></div>
      </section>
    </div>
    <script src="/web/app.js"></script>
  </body>
</html> 